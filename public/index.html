<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>سینک واچ | تماشای گروهی</title>
<script src="/socket.io/socket.io.js"></script>
<link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/misc/Farsi-Digits/wf/vazirmatn-fd.css" rel="stylesheet" />
<style>
:root{
--primary:#8b5cf6;--primary-hover:#7c3aed;--secondary:#ec4899;--accent:#06b6d4;--bg-dark:#0f172a;
--glass-bg:rgba(15,23,42,.65);--glass-border:rgba(255,255,255,.08);
--text-main:#f8fafc;--text-muted:#94a3b8;--font-family:'Vazirmatn',sans-serif}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:var(--font-family);background:var(--bg-dark);color:var(--text-main);min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:1rem;overflow-x:hidden}

/* FIX: Laptop video too small */
.vid-container{width:100%;max-width:100% !important}
video{width:100%!important;height:auto!important;max-height:85vh;object-fit:contain;display:block}

/* Chat initially hidden */
.chat{display:none}

/* Chat toggle button */
#chatToggle{
position:fixed;bottom:20px;left:20px;z-index:9999;padding:14px 24px;border:none;border-radius:14px;
background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;font-weight:800;
box-shadow:0 5px 18px rgba(0,0,0,.35);cursor:pointer;transition:.25s;
}
#chatToggle:hover{transform:scale(1.08)}
</style>
</head>
<body>

<button id="chatToggle">چت</button>

<div class="app-container">
<h2>تماشای همزمان — سینما آنلاین</h2>
<div id="joinContainer">
<label>اتاق گفتگو:</label>
<input id="roomId" value="room1">
<button id="joinBtn">شروع تماشا</button>
</div>
<div class="content-wrapper">
<div class="vid-container"><video id="video" controls class="vid"><source src="../sample.mp4"></video></div>
<div class="chat">
<div class="chat-card">
<div class="chat-header">پیام‌ها</div>
<div id="chatContainer"></div>
<div id="chatInputContainer">
<input id="chatInput" placeholder="پیام...">
<button id="sendBtn">ارسال</button>
</div></div></div></div></div>

<script>
const socket=io();
const video=document.getElementById('video');
const joinBtn=document.getElementById('joinBtn');
const roomIdInput=document.getElementById('roomId');
const chatContainer=document.getElementById('chatContainer');
const chatInput=document.getElementById('chatInput');
const sendBtn=document.getElementById('sendBtn');
const chatBox=document.querySelector('.chat');
const chatToggle=document.getElementById('chatToggle');
let joinedRoom=null,suppressLocalEvents=false;
const userName="کاربر "+Math.floor(Math.random()*1000);

joinBtn.onclick=()=>{
document.querySelector('.vid').style.display='block';
chatBox.style.display='block';
const joinContainer=document.getElementById('joinContainer');
joinContainer.style.display='none';
const roomId=roomIdInput.value.trim();if(!roomId)return alert('یک room id وارد کن');
joinedRoom=roomId;socket.emit('join-room',{roomId,userName});socket.emit('request-sync',{roomId});}

chatToggle.onclick=()=>{
if(chatBox.style.display==='none'){chatBox.style.display='block'}else{chatBox.style.display='none'}
}

sendBtn.onclick=sendMessage;
chatInput.addEventListener('keydown',e=>{if(e.key==='Enter')sendMessage()});
function sendMessage(){const msg=chatInput.value.trim();if(!msg||!joinedRoom)return;
socket.emit('chat-message',{roomId:joinedRoom,userName,message:msg});chatInput.value='';addMessage(userName,msg,true)}
socket.on('chat-message',({userName:sender,message})=>{addMessage(sender,message,sender===userName)});
function addMessage(sender,message,self){const div=document.createElement('div');div.textContent=sender+': '+message;chatContainer.appendChild(div);chatContainer.scrollTop=chatContainer.scrollHeight}

socket.on('sync-state',({time,playing})=>{suppressLocalEvents=true;if(Math.abs(video.currentTime-time)>0.5)video.currentTime=time;if(playing)video.play().catch(()=>{});else video.pause();setTimeout(()=>suppressLocalEvents=false,200)});
['play','pause'].forEach(evt=>{video.addEventListener(evt,()=>{if(!joinedRoom||suppressLocalEvents)return;socket.emit(evt,{roomId:joinedRoom,time:video.currentTime})})});
video.addEventListener('seeking',()=>{if(!joinedRoom||suppressLocalEvents)return;socket.emit('seek',{roomId:joinedRoom,time:video.currentTime})});
socket.on('play',({time})=>{suppressLocalEvents=true;if(Math.abs(video.currentTime-time)>0.5)video.currentTime=time;video.play();setTimeout(()=>suppressLocalEvents=false,200)});
socket.on('pause',({time})=>{suppressLocalEvents=true;if(Math.abs(video.currentTime-time)>0.5)video.currentTime=time;video.pause();setTimeout(()=>suppressLocalEvents=false,200)});
socket.on('seek',({time})=>{suppressLocalEvents=true;video.currentTime=time;setTimeout(()=>suppressLocalEvents=false,200)});
</script>
</body></html>
