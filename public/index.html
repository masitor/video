<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>سینک واچ | تماشای گروهی</title>
  <script src="/socket.io/socket.io.js"></script>
  <!-- فونت فارسی وزیرمتن -->
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/misc/Farsi-Digits/wf/vazirmatn-fd.css" rel="stylesheet" type="text/css" />
  
 <style>
/* --- Variables & Reset --- */
:root {
  --primary: #8b5cf6;
  --primary-hover: #7c3aed;
  --secondary: #ec4899;
  --accent: #06b6d4;
  --bg-dark: #0f172a;
  --glass-bg: rgba(15, 23, 42, 0.65);
  --glass-border: rgba(255, 255, 255, 0.08);
  --text-main: #f8fafc;
  --text-muted: #94a3b8;
  --shadow-color: rgba(0, 0, 0, 0.25);
  --font-family: 'Vazirmatn', sans-serif;
}

* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

body {
  font-family: var(--font-family);
  background-color: var(--bg-dark);
  background: linear-gradient(-45deg, #0f172a, #1e1b4b, #312e81, #0f172a);
  background-size: 400% 400%;
  animation: gradientBG 15s ease infinite;
  color: var(--text-main);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 1rem;
  overflow-x: hidden;
}

@keyframes gradientBG {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

/* --- Layout Container --- */
.app-container {
  width: 100%;
  max-width: 1600px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2rem;
  z-index: 10;
  position: relative;
}

/* --- Floating Shapes --- */
.shape {
  position: fixed;
  filter: blur(80px);
  z-index: -1;
  opacity: 0.4;
  animation: float 10s infinite ease-in-out alternate;
}
.shape-1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: var(--primary); animation-delay: 0s; }
.shape-2 { bottom: -10%; right: -10%; width: 60vw; height: 60vw; background: var(--secondary); animation-delay: -5s; }

@keyframes float {
  from { transform: translate(0, 0); }
  to { transform: translate(30px, 50px); }
}

/* --- Typography --- */
h2 {
  font-weight: 900;
  font-size: clamp(1.8rem, 5vw, 3rem);
  margin-bottom: 0.5rem;
  background: linear-gradient(to right, var(--accent), var(--secondary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  text-align: center;
  filter: drop-shadow(0 0 20px rgba(236, 72, 153, 0.3));
  animation: fadeInDown 0.8s ease-out;
}

/* --- Join Section --- */
#joinContainer {
  display: flex;
  flex-direction: column;
  gap: 15px;
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  padding: 2rem;
  border-radius: 24px;
  border: 1px solid var(--glass-border);
  box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
  width: 100%;
  max-width: 400px;
  transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  animation: zoomIn 0.6s ease-out;
}

@media (min-width: 640px) {
  #joinContainer {
    flex-direction: row;
    max-width: fit-content;
    align-items: center;
    padding: 1.5rem 2rem;
  }
}

#joinContainer label {
  font-weight: 500;
  color: var(--text-muted);
  white-space: nowrap;
}

#roomId {
  width: 100%;
  padding: 14px 20px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,0.1);
  background: rgba(0, 0, 0, 0.3);
  color: #fff;
  font-size: 1.1rem;
  font-family: 'Segoe UI', sans-serif;
  text-align: center;
  transition: all 0.3s ease;
  box-shadow: inset 0 2px 5px rgba(0,0,0,0.2);
}

@media (min-width: 640px) { #roomId { width: 220px; } }

#roomId:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.2);
  transform: scale(1.02);
}

#joinBtn {
  width: 100%;
  padding: 14px 24px;
  border: none;
  border-radius: 14px;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: #fff;
  font-weight: 800;
  font-size: 1rem;
  font-family: var(--font-family);
  cursor: pointer;
  position: relative;
  overflow: hidden;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(236, 72, 153, 0.4);
}

@media (min-width: 640px) { #joinBtn { width: auto; } }

#joinBtn:hover {
  transform: translateY(-3px) scale(1.02);
  box-shadow: 0 8px 25px rgba(236, 72, 153, 0.6);
}

#joinBtn:active { transform: translateY(-1px); }

/* --- Main Content Layout --- */
.content-wrapper {
  display: grid;
  grid-template-columns: 1fr;
  width: 100%;
  gap: 1.5rem;
  opacity: 0;
  animation: fadeInUp 1s ease-out forwards;
  animation-delay: 0.2s;
}

@media (min-width: 1024px) {
  .content-wrapper {
    grid-template-columns: 1fr 380px;
    align-items: start;
  }
}

/* حالت بدون چت */
.content-wrapper.no-chat {
  grid-template-columns: 1fr !important;
}

/* --- Video Player --- */
.vid-container {
  position: relative;
  border-radius: 24px;
  overflow: hidden;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
  border: 1px solid var(--glass-border);
  background: #000;
  width: 100%;
  transition: all 0.3s ease;
}

/* حالت تمام صفحه وقتی چت بسته است */
.content-wrapper.no-chat .vid-container {
  max-width: 100%;
  width: 100%;
}

/* ویدیو اصلی */
video {
  width: 100%;
  display: block;
  aspect-ratio: 16/9; 
  object-fit: contain;
}

/* --- Chat Section --- */
.chat {
  display: none;
  width: 100%;
  height: 100%;
}

/* دکمه باز/بسته کردن چت */
.chat-toggle-btn {
  position: absolute;
  left: 15px;
  top: 15px;
  z-index: 20;
  background: rgba(15, 23, 42, 0.7);
  backdrop-filter: blur(10px);
  border: 1px solid var(--glass-border);
  border-radius: 10px;
  color: white;
  padding: 8px 12px;
  cursor: pointer;
  font-family: var(--font-family);
  font-size: 0.9rem;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 5px;
}

.chat-toggle-btn:hover {
  background: var(--primary);
  transform: translateY(-2px);
}

/* --- Mobile Video Fix --- */
@media (max-width: 640px) {
  .vid-container {
    width: 100vw;  /* عرض کامل صفحه */
    max-width: 100vw;
    height: auto;
  }
  video {
    width: 100%;
    height: auto;
    aspect-ratio: auto;
    object-fit: contain;
  }
}

/* --- Animations --- */
@keyframes fadeInDown { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
@keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
@keyframes zoomIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

/* --- JS Toggle Helpers --- */
.vid { display: none; }
.vid[style*="display: block"] {
  display: block !important;
  animation: zoomIn 0.5s ease;
  width: 100%;
}

.chat[style*="display: block"] {
  display: block !important;
  animation: fadeInUp 0.6s ease 0.1s backwards;
}
</style>

</head>
<body>
  
  <!-- Background Shapes -->
  <div class="shape shape-1"></div>
  <div class="shape shape-2"></div>

  <div class="app-container">
    <h2>تماشای همزمان — سینما آنلاین</h2>

    <div id="joinContainer">
      <label for="roomId">اتاق گفتگو:</label>
      <input id="roomId" value="room1" placeholder="شناسه اتاق...">
      <button id="joinBtn">شروع تماشا</button>
    </div>

    <!-- Wrapper to handle layout when items become visible -->
    <div class="content-wrapper">
      <div class="vid-container">
        <!-- دکمه باز/بسته کردن چت -->
        <button class="chat-toggle-btn" id="chatToggleBtn">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
          </svg>
          باز کردن چت
        </button>
        <video id="video" controls class="vid">
          <source src="../sample.mp4" type="video/mp4">
          مرورگر شما ویدیو را پشتیبانی نمی‌کند.
        </video>
      </div>

      <div class="chat">
        <div class="chat-card">
          <div class="chat-header">
            <span>پیام‌ها</span>
            <button class="chat-close-btn" id="closeChatBtn">✕</button>
          </div>
          <div id="chatContainer">
            <div style="text-align: center; color: rgba(255,255,255,0.3); font-size: 0.85rem; margin-top: 20px;">
              خوش آمدید! <br> اینجا می‌توانید با دوستانتان گفتگو کنید.
            </div>
          </div>
          <div id="chatInputContainer">
            <input id="chatInput" placeholder="پیام..." autocomplete="off" />
            <button id="sendBtn">
              <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- EXACT ORIGINAL LOGIC (DO NOT TOUCH) ---
    const socket = io();
    const video = document.getElementById('video');
    const joinBtn = document.getElementById('joinBtn');
    const roomIdInput = document.getElementById('roomId');
    const chatContainer = document.getElementById('chatContainer');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');

    // اضافه کردن متغیرهای جدید
    const chatToggleBtn = document.getElementById('chatToggleBtn');
    const closeChatBtn = document.getElementById('closeChatBtn');
    const contentWrapper = document.querySelector('.content-wrapper');

    let joinedRoom = null;
    let suppressLocalEvents = false;
    const userName = "کاربر " + Math.floor(Math.random()*1000);

    // تابع برای تغییر وضعیت چت
    function toggleChat(show) {
      const chat = document.querySelector('.chat');
      if (show) {
        chat.style.display = 'block';
        contentWrapper.classList.remove('no-chat');
        chatToggleBtn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
          </svg>
          بستن چت
        `;
      } else {
        chat.style.display = 'none';
        contentWrapper.classList.add('no-chat');
        chatToggleBtn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
          </svg>
          باز کردن چت
        `;
      }
    }

    // رویداد کلیک برای دکمه باز/بسته کردن چت
    chatToggleBtn.addEventListener('click', function() {
      const chat = document.querySelector('.chat');
      const isChatVisible = chat.style.display === 'block';
      toggleChat(!isChatVisible);
    });

    // رویداد کلیک برای دکمه بستن چت
    closeChatBtn.addEventListener('click', function() {
      toggleChat(false);
    });

    // Join Room
    joinBtn.onclick = () => {
      // نمایش چت و ویدیو
      toggleChat(true);
      document.querySelector(".vid").style.display="block";
      
      // UI cleanup: Hide join bar smoothly
      const joinContainer = document.getElementById('joinContainer');
      joinContainer.style.opacity = '0';
      joinContainer.style.transform = 'translateY(-20px)';
      setTimeout(() => { joinContainer.style.display = 'none'; }, 400);

      const roomId = roomIdInput.value.trim();
      if (!roomId) return alert("یک room id وارد کن");
      joinedRoom = roomId;
      socket.emit("join-room", { roomId, userName });
      socket.emit("request-sync", { roomId });
    };

    // Video Sync
    socket.on("sync-state", ({ time, playing }) => {
      suppressLocalEvents = true;
      if (Math.abs(video.currentTime - time) > 0.5) video.currentTime = time;
      if (playing) video.play().catch(()=>{});
      else video.pause();
      setTimeout(()=> suppressLocalEvents=false, 200);
    });

    ['play','pause'].forEach(evt=>{
      video.addEventListener(evt, () => {
        if (!joinedRoom || suppressLocalEvents) return;
        socket.emit(evt, { roomId: joinedRoom, time: video.currentTime });
      });
    });

    video.addEventListener('seeking', () => {
      if (!joinedRoom || suppressLocalEvents) return;
      socket.emit('seek', { roomId: joinedRoom, time: video.currentTime });
    });

    socket.on('play', ({ time }) => { suppressLocalEvents = true; if (Math.abs(video.currentTime - time)>0.5) video.currentTime=time; video.play().catch(()=>{}); setTimeout(()=>suppressLocalEvents=false,200); });
    socket.on('pause', ({ time }) => { suppressLocalEvents = true; if (Math.abs(video.currentTime - time)>0.5) video.currentTime=time; video.pause(); setTimeout(()=>suppressLocalEvents=false,200); });
    socket.on('seek', ({ time }) => { suppressLocalEvents=true; video.currentTime=time; setTimeout(()=>suppressLocalEvents=false,200); });

    // Chat
    sendBtn.onclick = sendMessage;
    chatInput.addEventListener('keydown', e => { if(e.key==='Enter') sendMessage(); });

    function sendMessage() {
      const msg = chatInput.value.trim();
      if (!msg || !joinedRoom) return;
      socket.emit('chat-message', { roomId: joinedRoom, userName, message: msg });
      chatInput.value = '';
      addMessage(userName, msg, true);
    }

    socket.on('chat-message', ({ userName: sender, message }) => {
      const isSelf = sender === userName;
      addMessage(sender, message, isSelf);
    });

    function addMessage(sender, message, self=false) {
      const div = document.createElement('div');
      div.className = 'chat-message ' + (self ? 'self' : 'other');
      div.textContent = sender + ': ' + message;
      chatContainer.appendChild(div);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // Heartbeat
    setInterval(() => {
      if (!joinedRoom) return;
      if (!video.paused) socket.emit('heartbeat', { roomId: joinedRoom, time: video.currentTime });
    }, 5000);
  </script>
</body>
</html>



